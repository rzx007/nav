var x=Object.defineProperty;var R=(s,a,i)=>a in s?x(s,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[a]=i;var v=(s,a,i)=>(R(s,typeof a!="symbol"?a+"":a,i),i);import{d as I,h as b,y as P,S as O,o as c,c as g,m as k,F as M,G as N,n as $,t as S,e as T,a5 as V,a6 as L,a2 as j,J,a as W,V as X}from"./chunks/framework.7XExV1ji.js";class z{constructor(a){v(this,"signal");v(this,"objectToFormData",a=>{const i=new FormData;for(const p in a)if(Object.prototype.hasOwnProperty.call(a,p)){const n=a[p];if(n==null)continue;n instanceof File||n instanceof Blob?i.append(p,n):typeof n=="object"?i.append(p,JSON.stringify(n)):i.append(p,String(n))}return i});this.signal=a??new AbortController().signal}async createChatStream(a){const i=await fetch("https://jiangshigpt4.openai.azure.com/openai/deployments/gpt-4o/chat/completions?api-version=2024-03-01-preview",{method:"POST",signal:this.signal,headers:{Chattoken:"372a9640-73db-491a-8eaf-2752e3101bce","api-key":"61c36ab3c518418b916a6ffc2190d170","Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok)throw new Error(`API request failed: ${i.statusText}`);return i}}function G(s){let a="",i=[],p="";return new TransformStream({async start(){var n;await((n=s==null?void 0:s.onStart)==null?void 0:n.call(s))},async transform(n,y){var u,F,r,A;try{p+=n;const m=p.split(`
`);p=m.pop()||"";for(const f of m){if(!f.trim().startsWith("data: "))continue;const E=f.replace("data: ","").trim();if(E==="[DONE]"){await((u=s==null?void 0:s.onFinish)==null?void 0:u.call(s,a));return}try{const B=JSON.parse(E),{choices:d}=B;if(!d||d.length===0)continue;const{delta:o}=d[0];o.content?(a+=o.content,await((F=s==null?void 0:s.onToken)==null?void 0:F.call(s,o.content))):o.tool_calls&&(i=[...i,...o.tool_calls],await((r=s==null?void 0:s.onToolCall)==null?void 0:r.call(s,i)))}catch(B){console.warn("JSON parse error:",B);continue}}y.enqueue(n)}catch(m){await((A=s==null?void 0:s.onError)==null?void 0:A.call(s,m))}}})}const U={class:"chat-container"},H={class:"messages-container"},K={class:"message-content"},Q={key:0,class:"tool-calls"},Y={key:0,class:"message assistant"},Z={class:"message-content"},ss=["disabled"],is=["disabled"],_=3,as=I({__name:"index",setup(s){const a=[{type:"function",function:{name:"get_weather",description:"Get current weather for a location",parameters:{type:"object",properties:{location:{type:"string",description:"City name"}},required:["location"]}}}],i=b([]),p=b(""),n=b(!1),y=b(""),u=b(null),F=b(new AbortController),r=b(0),A=new z(F.value.signal),m=()=>{u.value&&u.value.scrollIntoView({behavior:"smooth"})};P([i,y],()=>{O(m)});const f=async C=>(await new Promise(h=>setTimeout(h,1e3)),{temperature:22,condition:"sunny",location:C.location}),E=()=>{y.value="",n.value=!1,r.value=0,F.value=new AbortController},B=async(C,h)=>{const t=C.body.pipeThrough(new TextDecoderStream).pipeThrough(G({onStart:async()=>{i.value.push(h)},onToken:async l=>{y.value+=l},onToolCall:async l=>{let e="";for(const w of l){e+=w.function.arguments,console.log("toolCallArgs",e);try{const D=JSON.parse(e),q=await f(D);i.value.push({role:"assistant",content:`Weather in ${D.location}: ${q.temperature}°C, ${q.condition}`,toolCalls:[w]})}catch(D){console.error("Tool call error:",D)}}},onFinish:async l=>{l.trim()&&i.value.push({role:"assistant",content:l}),E()},onError:async l=>{console.error("Stream error:",l),r.value<_?(r.value++,await d(h.content,!0)):(i.value.push({role:"assistant",content:"Sorry, I encountered an error. Please try again."}),E())}}));try{const l=t.getReader();for(;;){const{done:e}=await l.read();if(e)break}}catch(l){console.error("Stream reading error:",l),r.value<_?(r.value++,await d(h.content,!0)):(i.value.push({role:"assistant",content:"Sorry, I encountered an error. Please try again."}),E())}},d=async(C,h=!1)=>{const t=C||p.value.trim();if(!t||n.value)return;h||E();const l={role:"user",content:t};n.value=!0;try{const e=await A.createChatStream({frequency_penalty:0,messages:[l],model:"gpt-40",presence_penalty:0,stream:!0,temperature:.6,tools:a,top_p:1});if(!e.ok)throw new Error(`API request failed: ${e.statusText}`);await B(e,l)}catch(e){console.error("Chat error:",e),r.value<_?(r.value++,await d(t,!0)):(i.value.push({role:"assistant",content:"Sorry, I encountered an error. Please try again."}),E())}finally{h||(p.value="")}},o=()=>{F.value.abort(),E()};return(C,h)=>(c(),g("div",U,[k("div",H,[(c(!0),g(M,null,N(i.value,(t,l)=>{var e;return c(),g("div",{key:l,class:$(["message",t.role])},[k("div",K,S(t.content),1),t.toolCalls?(c(),g("div",Q," Tool used: "+S((e=t.toolCalls[0])==null?void 0:e.function.name),1)):T("",!0)],2)}),128)),y.value?(c(),g("div",Y,[k("div",Z,S(y.value),1)])):T("",!0),k("div",{ref_key:"messagesEndRef",ref:u},null,512)]),k("form",{onSubmit:j(d,["prevent"]),class:"input-form"},[V(k("input",{type:"text","onUpdate:modelValue":h[0]||(h[0]=t=>p.value=t),placeholder:"Type your message...",disabled:n.value},null,8,ss),[[L,p.value]]),n.value?(c(),g("button",{key:0,type:"button",onClick:o}," Cancel ")):(c(),g("button",{key:1,type:"submit",disabled:!p.value.trim()}," Send ",8,is))],32)]))}}),ns=k("h1",{id:"使用openai的chat-api实现一个聊天应用",tabindex:"-1"},[W("使用OpenAI的Chat API实现一个聊天应用 "),k("a",{class:"header-anchor",href:"#使用openai的chat-api实现一个聊天应用","aria-label":'Permalink to "使用OpenAI的Chat API实现一个聊天应用"'},"​")],-1),ls=k("div",{class:"tip custom-block"},[k("p",{class:"custom-block-title"},"TIP"),k("p",null,"实现一个简单的聊天应用")],-1),ps=X("",1),ks=JSON.parse('{"title":"使用OpenAI的Chat API实现一个聊天应用","description":"","frontmatter":{},"headers":[],"relativePath":"html-dom/OpenAI-chat.md","filePath":"html-dom/OpenAI-chat.md","lastUpdated":1737337237000}'),es={name:"html-dom/OpenAI-chat.md"},rs=Object.assign(es,{setup(s){return(a,i)=>(c(),g("div",null,[ns,ls,J(as),ps]))}});export{ks as __pageData,rs as default};
